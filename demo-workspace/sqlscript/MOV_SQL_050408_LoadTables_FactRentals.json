{
	"name": "MOV_SQL_050408_LoadTables_FactRentals",
	"properties": {
		"description": "OpenHack MDWH\nAzure Synapse Analytics Demo\nhttps://github.com/aessing/demo-azuresynapse\n\nDeveloper: Andre Essing\n(https://www.andre-essing.de/)\n(https://github.com/aessing)\n(https://twitter.com/aessing)\n(https://www.linkedin.com/in/aessing/)\n\nTHIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\nEITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\nWARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.",
		"folder": {
			"name": "Movies/Challenge 05 - 04 Load Tables"
		},
		"content": {
			"query": "-- =============================================================================\n-- OpenHack MDWH\n-- Azure Synapse Analytics Demo\n-- https://github.com/aessing/demo-azuresynapse\n-- -----------------------------------------------------------------------------\n-- Developer.......: Andre Essing (https://www.andre-essing.de/)\n--                                (https://github.com/aessing)\n--                                (https://twitter.com/aessing)\n--                                (https://www.linkedin.com/in/aessing/)\n-- -----------------------------------------------------------------------------\n-- THIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\n-- EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\n-- WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.\n-- =============================================================================\n\n-- TRUNCATE TABLE [dbo].[FactRentals]\n\n-- Load table\nDECLARE @MaxSK INT;\nSELECT @MaxSK = ISNULL(MAX(RentalSK), 0) FROM [dbo].[FactRentals]\n\nINSERT INTO [dbo].[FactRentals] (\n    [RentalSK],\n    [TransactionID],\n    [CustomerSK],\n    [LocationSK],\n    [MovieSK],\n    [RentalDateSK],\n    [ReturnDateSK],\n    [RentalDuration],\n    [RentalCost],\n    [LateFee],\n    [TotalCost],\n    [RewindFlag]\n)\nSELECT * FROM (\n\tSELECT \n\t\t@MaxSK + ROW_NUMBER() OVER (ORDER BY ExternalTable.TransactionID) AS RentalSK,\n\t\tExternalTable.TransactionID AS TransactionID,\n\t\tExternalTable.CustomerSK AS CustomerSK,\n\t\tExternalTable.LocationSK AS LocationSK,\n\t\tExternalTable.MovieSK AS MovieSK,\n\t\tExternalTable.RentalDateSK AS RentalDateSK,\n\t\tExternalTable.ReturnDateSK AS ReturnDateSK,\n\t\tExternalTable.RentalDuration AS RentalDuration,\n\t\tExternalTable.RentalCost AS RentalCost,\n\t\tExternalTable.LateFee AS LateFee,\n\t\tExternalTable.TotalCost AS TotalCost,\n\t\tExternalTable.RewindFlag AS RewindFlag\n\tFROM (\n\t\tSELECT\n\t\t\tren.SourceSystemTransactionID AS TransactionID,\n\t\t\t(\n\t\t\t\tSELECT TOP 1\n\t\t\t\t\tCustomerSK \n\t\t\t\tFROM \n\t\t\t\t\t[dbo].[DimCustomers] dcust\n\t\t\t\tJOIN\n\t\t\t\t\t[ext].[Customers] cust\n\t\t\t\t\tON dcust.LastName = cust.LastName\n\t\t\t\t\tAND dcust.FirstName = cust.FirstName\n\t\t\t\t\tAND dcust.ZipCode = cust.ZipCode\n\t\t\t\t\tAND dcust.City = cust.City\n\t\t\t\t\tAND dcust.State = cust.State\n\t\t\t\tWHERE\n\t\t\t\t\tren.CustomerID = cust.SourceSystemCustomerID\n\t\t\t) AS CustomerSK,\n\t\t\tren.SourceSystemID AS LocationSK,\n\t\t\t(\n\t\t\t\tSELECT TOP 1\n\t\t\t\t\tMovieSK \n\t\t\t\tFROM \n\t\t\t\t\t[dbo].[DimMovies] mov \n\t\t\t\tJOIN\n\t\t\t\t\t[ext].[Catalog] cat \n\t\t\t\t\tON mov.MovieTitle = cat.Title \n\t\t\t\tWHERE\n\t\t\t\t\tren.MovieID = cat.SourceSystemMovieID\n\t\t\t) AS MovieSK,\n\t\t\trendat.DateSK AS RentalDateSK,\n\t\t\tretdat.DateSK AS ReturnDateSK,\n\t\t\tCASE\n\t\t\t\tWHEN DATEDIFF(d, ren.RentalDate, ren.ReturnDate) < 0 THEN NULL\n\t\t\t\tELSE DATEDIFF(d, ren.RentalDate, ren.ReturnDate)\n\t\t\tEND AS RentalDuration,\n\t\t\tren.RentalCost,\n\t\t\tren.LateFee,\n\t\t\tren.RentalCost + ren.LateFee AS TotalCost,\n\t\t\tren.RewindFlag\n\t\tFROM\n\t\t\t[ext].[rentals] ren\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimDate] rendat\n\t\t\tON ren.RentalDate = rendat.DateValue\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimDate] retdat\n\t\t\tON ren.ReturnDate = retdat.DateValue\n\t) ExternalTable\n) CleansedTable\nWHERE CleansedTable.TransactionID NOT IN (SELECT TransactionID FROM [dbo].[FactRentals])\n\n-- Check Load\n-- SELECT COUNT(*) FROM [dbo].[FactRentals]\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Movies",
				"databaseName": "Movies"
			}
		},
		"type": "SqlQuery"
	}
}